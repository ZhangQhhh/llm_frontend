<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å¤šè½®çŸ¥è¯†å¯¹è¯ï¼ˆå®Œæ•´ç‰ˆ Â· å®½å± Â· å¯æŠ˜å å‚è€ƒä¸æ€è€ƒåˆ†åŒºï¼‰</title>
<style>
/* ----------------- å­—ä½“ï¼ˆè¯·æŒ‰å†…ç½‘å®é™…è·¯å¾„æ›¿æ¢ï¼‰ ----------------- */
@font-face {
  font-family: "Noto Sans SC";
  font-weight: 400;
  src: url('/static/fonts/SourceHanSansSC-Regular.otf') format('opentype');
}
@font-face {
  font-family: "Noto Sans SC";
  font-weight: 600;
  src: url('/static/fonts/SourceHanSansSC-Medium.otf') format('opentype');
}
@font-face {
  font-family: "Noto Serif SC";
  font-weight: 700;
  src: url('/static/fonts/SourceHanSerifCN-Bold.otf') format('opentype');
}

/* ----------------- ä¸»é¢˜å˜é‡ ----------------- */
:root{
  --accentA: #7c3aed;
  --accentB: #06b6d4;
  --muted: #64748b;
  --bg: #f7fbff;
  --card: #ffffff;
  --text-primary: #1a202c; /* æ›´æ·±çš„æ–‡æœ¬é¢œè‰² */
  --text-secondary: #4a5568; /* æ¬¡è¦æ–‡æœ¬é¢œè‰² */
}

/* ----------------- å…¨å±€ ----------------- */
html,body{
  height:100%;
  margin:0;
  font-family:"Noto Sans SC",system-ui,"Segoe UI",Roboto,"Microsoft YaHei",sans-serif;
  background:linear-gradient(180deg,var(--bg),#eef3ff);
  color:var(--text-primary);
  line-height:1.6; /* å¢åŠ è¡Œé«˜ */
}
.wrap{
  max-width:1400px;
  margin:24px auto; /* å¢åŠ å¤–è¾¹è· */
  padding:24px; /* å¢åŠ å†…è¾¹è· */
  box-sizing:border-box;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:18px; /* å¢åŠ é—´è· */
}
.brand{
  display:flex;
  gap:16px; /* å¢åŠ é—´è· */
  align-items:center;
}
.logo{
  width:60px; /* å¢å¤§Logo */
  height:60px; /* å¢å¤§Logo */
  border-radius:14px;
  background:linear-gradient(135deg,var(--accentA),var(--accentB));
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-weight:700;
  font-family:"Noto Serif SC",serif;
  font-size:24px; /* å¢å¤§Logoå­—ä½“ */
}
h1{
  margin:0;
  font-family:"Noto Serif SC",serif;
  font-size:22px; /* å¢å¤§æ ‡é¢˜ */
  color:var(--text-primary);
}
.subtitle{
  font-size:14px; /* å¢å¤§å‰¯æ ‡é¢˜ */
  color:var(--muted);
  margin-top:6px;
}
.user-panel{
  display:flex;
  gap:12px;
  align-items:center;
}
.btn{
  border:0;
  padding:10px 16px; /* å¢å¤§æŒ‰é’® */
  border-radius:12px;
  cursor:pointer;
  font-weight:700;
  background:linear-gradient(90deg,var(--accentA),var(--accentB));
  color:#fff;
  box-shadow:0 8px 24px rgba(124,58,237,0.18); /* è°ƒæ•´é˜´å½± */
  font-size:15px; /* å¢å¤§æŒ‰é’®å­—ä½“ */
}
.btn.ghost{
  background:#fff;
  border:1px solid #e0e7ef;
  color:var(--text-primary);
  box-shadow:none;
  font-weight:600;
}
.token-indicator{
  font-size:14px;
  color:var(--muted);
}

/* ----------------- ä¸»å¡ç‰‡ ----------------- */
.card{
  background:var(--card);
  border-radius:16px; /* å¢å¤§åœ†è§’ */
  padding:20px; /* å¢åŠ å†…è¾¹è· */
  box-shadow:0 18px 50px rgba(2,6,23,0.08); /* æ›´æ˜æ˜¾çš„é˜´å½± */
  position:relative;
}
.locked-overlay{
  position:absolute;
  inset:0;
  background:rgba(255,255,255,0.75);
  backdrop-filter:blur(4px); /* ç•¥å¾®å¢å¼ºæ¨¡ç³Š */
  border-radius:16px;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

/* æ§ä»¶ */
textarea#questionInput{
  width:100%;
  min-height:150px; /* å¢å¤§è¾“å…¥æ¡†é«˜åº¦ */
  border-radius:12px;
  padding:16px;
  border:1px solid #dbe2ed; /* è°ƒæ•´è¾¹æ¡†é¢œè‰² */
  font-size:16px; /* å¢å¤§è¾“å…¥æ¡†å­—ä½“ */
  resize:vertical;
  box-sizing:border-box;
  box-shadow:inset 0 1px 3px rgba(0,0,0,0.05); /* å¢åŠ å†…é˜´å½± */
}
.control-row{
  display:flex;
  align-items:center;
  gap:12px;
  margin-top:16px;
  flex-wrap:wrap;
}
select,input[type=number]{
  padding:9px 12px;
  border-radius:10px;
  border:1px solid #dbe2ed;
  font-size:15px; /* å¢å¤§æ§ä»¶å­—ä½“ */
}
.right-actions{
  margin-left:auto;
  display:flex;
  align-items:center;
  gap:12px;
}

/* ----------------- å›ç­”ä¸ä¾§æ å¸ƒå±€ ----------------- */
.answer-area{
  display:grid;
  grid-template-columns:70% 30%; /* è°ƒæ•´æ¯”ä¾‹ */
  gap:24px; /* å¢åŠ é—´è· */
  margin-top:24px;
}
.conversation{
  background:#fbfdff;
  border-radius:14px;
  border:1px solid #e6eef8;
  padding:18px; /* å¢åŠ å†…è¾¹è· */
  height:80vh; /* ç•¥å¾®å¢åŠ é«˜åº¦ */
  overflow:auto;
  box-sizing:border-box;
  box-shadow:inset 0 1px 4px rgba(0,0,0,0.02); /* è½»å¾®å†…é˜´å½± */
}
.sidebar{
  background:#fff;
  border-radius:14px;
  border:1px solid #eef2ff;
  padding:16px; /* å¢åŠ å†…è¾¹è· */
  height:80vh;
  display:flex;
  flex-direction:column;
  box-sizing:border-box;
  overflow:hidden;
  box-shadow:0 4px 15px rgba(0,0,0,0.04);
}

/* ----------------- å¯¹è¯æ°”æ³¡æ ·å¼ä¼˜åŒ– ----------------- */
.msg{
  display:flex;
  gap:12px;
  margin-bottom:18px; /* å¢åŠ æ°”æ³¡é—´è· */
  align-items:flex-start;
}
.msg.user{justify-content:flex-end;}
.msg .bubble{
  max-width:90%;
  padding:16px 20px; /* å¢å¤§æ°”æ³¡å†…è¾¹è· */
  border-radius:16px; /* å¢å¤§åœ†è§’ */
  font-size:17px; /* å¢å¤§æ°”æ³¡å­—ä½“ */
  line-height:1.7;
  box-shadow:0 6px 18px rgba(2,6,23,0.06);
}
.msg.user .bubble{
  background:linear-gradient(90deg,var(--accentA),var(--accentB));
  color:#fff;
  border-bottom-right-radius:6px; /* è°ƒæ•´åœ†è§’ */
}
.msg.assistant .bubble{
  background:#fff;
  border:1px solid #eef2ff;
  color:var(--text-primary);
  border-bottom-left-radius:6px; /* è°ƒæ•´åœ†è§’ */
  white-space:pre-wrap;
  word-break:break-word;
}

/* ----------------- æ€è€ƒ/æ­£æ–‡åˆ†åŒºæ ·å¼ï¼ˆåµŒå…¥åˆ°åŠ©æ‰‹æ°”æ³¡ä¸­ï¼‰- ç•Œé¢ä¼˜åŒ–æ ¸å¿ƒ ----------------- */
.assistant-block{
  display:flex;
  flex-direction:column;
  gap:16px; /* å¢åŠ æ€è€ƒè¿‡ç¨‹ä¸æ­£æ–‡ä¹‹é—´çš„é—´è· */
}
.block-section{
  border-radius:12px; /* å¢å¤§åœ†è§’ */
  padding:14px 16px; /* å¢å¤§å†…è¾¹è· */
  margin-bottom:0; /* ç§»é™¤é»˜è®¤çš„margin-bottomï¼Œä½¿ç”¨gapæ§åˆ¶ */
}
.section-title{
  font-size:14px; /* å¢å¤§æ ‡é¢˜å­—ä½“ */
  color:var(--text-secondary); /* è°ƒæ•´é¢œè‰² */
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding-bottom:10px; /* å¢å¤§åº•éƒ¨å¡«å…… */
  margin-bottom:10px;
  border-bottom:1px dashed #e0e7ef; /* è°ƒæ•´æ ‡é¢˜ä¸‹åˆ’çº¿ */
}
.section-title .label{
  font-weight:700;
  font-size:15px; /* å¢å¤§æ ‡ç­¾å­—ä½“ */
  color:var(--text-primary);
}
.section-body{
  font-size:16px; /* å¢å¤§æ­£æ–‡å†…å®¹å­—ä½“ */
  color:var(--text-primary);
  white-space:pre-wrap;
  word-break:break-word;
  line-height:1.9; /* å¢åŠ è¡Œé«˜åˆ°1.9 */
}

/* ğŸ”¥ æ ¸å¿ƒä¼˜åŒ–ï¼šæ­£æ–‡å†…éƒ¨å…ƒç´ æ ·å¼ */
.section-body p {
  margin: 1.2em 0; /* æ®µè½é—´è· */
  line-height: 1.9;
}

.section-body p:first-child {
  margin-top: 0;
}

.section-body p:last-child {
  margin-bottom: 0;
}

/* æ ‡é¢˜æ ·å¼ */
.section-body h1, .section-body h2, .section-body h3,
.section-body h4, .section-body h5, .section-body h6 {
  margin: 1.5em 0 0.8em 0;
  font-weight: 700;
  line-height: 1.4;
  color: var(--text-primary);
}

.section-body h1 { font-size: 1.8em; border-bottom: 2px solid #e0e7ef; padding-bottom: 0.3em; }
.section-body h2 { font-size: 1.5em; border-bottom: 1px solid #e0e7ef; padding-bottom: 0.3em; }
.section-body h3 { font-size: 1.3em; }
.section-body h4 { font-size: 1.1em; }

/* åˆ—è¡¨æ ·å¼ */
.section-body ul, .section-body ol {
  margin: 1em 0;
  padding-left: 2em;
  line-height: 1.9;
}

.section-body ul {
  list-style-type: disc;
}

.section-body ol {
  list-style-type: decimal;
}

.section-body li {
  margin: 0.6em 0;
  padding-left: 0.3em;
}

.section-body li > p {
  margin: 0.4em 0;
}

/* åµŒå¥—åˆ—è¡¨ */
.section-body ul ul, .section-body ol ul {
  margin: 0.5em 0;
  list-style-type: circle;
}

.section-body ul ol, .section-body ol ol {
  margin: 0.5em 0;
}

/* ä»£ç å—æ ·å¼ */
.section-body code {
  background: #f5f7fa;
  padding: 0.2em 0.5em;
  border-radius: 4px;
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  font-size: 0.9em;
  color: #e91e63;
  border: 1px solid #e0e7ef;
}

.section-body pre {
  background: #f5f7fa;
  border: 1px solid #e0e7ef;
  border-radius: 8px;
  padding: 1.2em;
  margin: 1.2em 0;
  overflow-x: auto;
  line-height: 1.6;
}

.section-body pre code {
  background: transparent;
  padding: 0;
  border: none;
  color: #1a202c;
  font-size: 0.95em;
}

/* å¼•ç”¨å—æ ·å¼ */
.section-body blockquote {
  margin: 1.2em 0;
  padding: 1em 1.2em;
  border-left: 4px solid var(--accentA);
  background: #f8f9ff;
  color: #4a5568;
  font-style: italic;
  border-radius: 4px;
}

.section-body blockquote p {
  margin: 0.5em 0;
}

/* è¡¨æ ¼æ ·å¼ */
.section-body table {
  border-collapse: collapse;
  width: 100%;
  margin: 1.2em 0;
  font-size: 0.95em;
}

.section-body th, .section-body td {
  border: 1px solid #e0e7ef;
  padding: 0.8em 1em;
  text-align: left;
}

.section-body th {
  background: #f5f7fa;
  font-weight: 700;
  color: var(--text-primary);
}

.section-body tr:hover {
  background: #fafbfc;
}

/* æ°´å¹³çº¿æ ·å¼ */
.section-body hr {
  border: none;
  border-top: 2px solid #e0e7ef;
  margin: 2em 0;
}

/* é“¾æ¥æ ·å¼ */
.section-body a {
  color: var(--accentA);
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: border-bottom 0.2s;
}

.section-body a:hover {
  border-bottom: 1px solid var(--accentA);
}

/* å¼ºè°ƒæ ·å¼ */
.section-body strong {
  font-weight: 700;
  color: var(--text-primary);
}

.section-body em {
  font-style: italic;
  color: var(--text-secondary);
}

/* å›¾ç‰‡æ ·å¼ */
.section-body img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin: 1em 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* æ€è€ƒè¿‡ç¨‹éƒ¨åˆ† */
.assistant-block .block-section:first-child {
    background: #fdfdff; /* æ›´æµ…çš„èƒŒæ™¯ */
    border: 1px dashed #cfd8dc; /* è°ƒæ•´è™šçº¿è¾¹æ¡† */
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
}
.assistant-block .block-section:first-child .section-title {
    border-bottom: 1px solid #e0e7ef;
}
.assistant-block .block-section:first-child .section-title .label {
    color: #4b5563;
}
.assistant-block .block-section:first-child .section-title .label::before {
    content: "ğŸ§ ";
    margin-right: 10px; /* å¢å¤§å›¾æ ‡ä¸æ–‡å­—é—´è· */
}

/* æ­£æ–‡éƒ¨åˆ† */
.assistant-block .block-section:last-child {
    background: #ffffff;
    border: 1px solid #cce7ff; /* è°ƒæ•´è¾¹æ¡†é¢œè‰² */
    box-shadow: 0 6px 16px rgba(59,130,246,0.08); /* æ›´æ˜æ˜¾çš„é˜´å½± */
}
.assistant-block .block-section:last-child .section-title {
    border-bottom: 1px solid var(--accentA);
}
.assistant-block .block-section:last-child .section-title .label {
    color: #1e3a8a;
    font-size: 16px; /* å¢å¤§æ­£æ–‡æ ‡é¢˜å­—ä½“ */
}

/* æŠ˜å æŒ‰é’® */
.toggle-small{
  font-size:14px; /* å¢å¤§æŠ˜å æŒ‰é’®å­—ä½“ */
  color:var(--accentA);
  cursor:pointer;
  border:none;
  background:transparent;
  padding:5px 8px;
}
.small-muted{
  font-size:13px; /* å¢å¤§mutedæ–‡æœ¬ */
  color:var(--muted);
}

/* å‚è€ƒæ¥æºé¢æ¿ */
.references-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.references-list{
  overflow:auto;
  flex:1;
  padding-right:8px; /* å¢åŠ å³ä¾§å¡«å…… */
}
.reference-item{
  background:#fff;
  border:1px solid #eef2ff;
  border-radius:10px; /* å¢å¤§åœ†è§’ */
  padding:12px; /* å¢å¤§å†…è¾¹è· */
  margin-bottom:12px; /* å¢åŠ é—´è· */
  font-size:14px; /* å¢å¤§å‚è€ƒæ¥æºå­—ä½“ */
  line-height:1.7;
  box-shadow:0 2px 8px rgba(0,0,0,0.02);
}
.reference-meta{
  font-size:13px; /* å¢å¤§å…ƒæ•°æ®å­—ä½“ */
  color:var(--muted);
  margin-bottom:8px;
}
.ref-keypassage{
  margin-top:10px;
  padding:12px; /* å¢å¤§å†…è¾¹è· */
  border-left:4px solid #f59e0b; /* å¢å¤§è¾¹æ¡† */
  background:#fffbee; /* æ›´æµ…çš„èƒŒæ™¯ */
  border-radius:8px; /* å¢å¤§åœ†è§’ */
  color:#a0520e; /* è°ƒæ•´é¢œè‰² */
  font-size:14px; /* å¢å¤§å…³é”®æ®µè½å­—ä½“ */
}

/* æ›´å¤šæ¥æºæŠ˜å æ§åˆ¶ */
.references-collapsed .references-list{max-height:220px;} /* ç•¥å¾®å¢å¤§é»˜è®¤é«˜åº¦ */
.references-expanded .references-list{max-height:unset;}

/* loader */
.loader{width:32px;height:32px;border-radius:50%;border:4px solid #eef2ff;border-top-color:var(--accentA);animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* footer */
.footer{
  margin-top:18px;
  color:var(--muted);
  font-size:14px; /* å¢å¤§footerå­—ä½“ */
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* ç™»å½•æ¨¡æ€ */
.modal-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:2000;}
.login-modal{width:480px;max-width:94%;background:#fff;border-radius:14px;padding:20px;box-shadow:0 28px 70px rgba(2,6,23,0.35);}
.login-row{display:flex;flex-direction:column;gap:10px;margin-top:10px;}
.login-row input{padding:12px;border-radius:10px;border:1px solid #e6eef8;font-size:15px;}
.login-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:16px;}

/* å“åº”å¼ */
@media (max-width:1000px){
  .answer-area{grid-template-columns:1fr;}
  .conversation,.sidebar{height:auto;min-height:400px; /* å¢å¤§å°å±å¹•ä¸‹é«˜åº¦ */ }
  .logo{width:50px;height:50px;font-size:20px;}
  h1{font-size:20px;}
  .wrap{padding:18px;}
  .card{padding:18px;}
}
</style>
<script src="/static/marked.min.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">é—®</div>
      <div>
        <h1>å¤šè½®çŸ¥è¯†å¯¹è¯</h1>
        <div class="subtitle">å®½å± Â· æ”¯æŒå¤šè½® Â· æŠ˜å å‚è€ƒ Â· æ€è€ƒ/æ­£æ–‡åˆ†åŒºï¼ˆå†…ç½‘ï¼Œæ—  CDNï¼‰</div>
      </div>
    </div>

    <div class="user-panel">
      <div class="token-indicator" id="statusText">æœªç™»å½•</div>
      <button class="btn ghost" id="btnLogout" style="display:none">ç™»å‡º</button>
      <button class="btn" id="btnOpenLogin">ç™»å½•</button>
    </div>
  </header>

  <div class="card" id="mainCard">
    <div id="lockedOverlay" class="locked-overlay" style="display:none;">
      <div style="text-align:center;">
        <div style="font-weight:700;font-size:20px;">éœ€è¦ç™»å½•æ‰èƒ½ä½¿ç”¨</div>
        <div class="small-muted" style="margin-top:10px;font-size:14px;">è¯·ç‚¹å‡»å³ä¸Šè§’ç™»å½•æŒ‰é’®è¿›è¡Œç™»å½•ï¼ˆç™»å½• API åœ°å€ç•™ç©ºä»¥ä¾¿å†…ç½‘è°ƒè¯•ï¼‰ã€‚</div>
      </div>
    </div>

    <textarea id="questionInput" placeholder="è¯·è¾“å…¥é—®é¢˜ï¼ˆæ”¯æŒå¤šè½®å¯¹è¯ï¼‰ã€‚é¦–æ¬¡å‘é€ä¼šåˆ›å»º sessionï¼Œä¼šè¯ ID ä¿å­˜åœ¨æœ¬åœ°ï¼‰ã€‚"></textarea>

    <div class="control-row">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <label for="modelSelector" class="small-muted">æ¨¡å‹</label>
        <select id="modelSelector">
               <option value="qwen3-32b">qwen-32</option>
                <option value="qwen2025">qwenæ»¡è¡€ç‰ˆ</option>
                <option value="deepseek">deepseek-r1</option>
        </select>

        <label class="small-muted">å‚è€ƒæ•°</label>
        <input type="number" id="rerankTopNInput" value="10" min="1" max="30" style="width:80px;">

        <label class="small-muted"><input type="checkbox" id="thinkingModeToggle" checked> æ€è€ƒæ¨¡å¼</label>
        <label class="small-muted"><input type="checkbox" id="insertBlockToggle"> ç²¾å‡†æ£€ç´¢</label>
      </div>

      <div class="right-actions">
        <div id="currentSession" class="small-muted">ä¼šè¯ï¼šæ— </div>
        <div id="liveLoader" style="display:none"><div class="loader"></div></div>
        <button id="submitBtn" class="btn" disabled>å‘é€</button>
      </div>
    </div>

    <div class="answer-area" style="margin-top:24px;">
      <div class="conversation" id="conversation">
        <div class="small-muted" id="welcomeNote">æ¬¢è¿ â€” è¯·å…ˆç™»å½•å¹¶å‘é€é—®é¢˜ä»¥å¼€å§‹å¤šè½®å¯¹è¯ã€‚æœåŠ¡å™¨ç«¯å¤šè½®æ¥å£ï¼š<code>/api/knowledge_chat_conversation</code>ï¼ˆSSE æˆ–æµå¼å“åº”ï¼‰ã€‚</div>
      </div>

      <div class="sidebar references-collapsed" id="sidebar">
        <div class="references-header">
          <div style="font-weight:700;font-size:16px;">å‚è€ƒæ¥æº</div>
          <div style="display:flex;gap:10px;align-items:center;">
            <div class="small-muted" id="refCount">0 æ¡</div>
            <button id="toggleRefsBtn" class="toggle-small">æ›´å¤šæ¥æº â–¾</button>
          </div>
        </div>

        <div class="references-list" id="references" style="overflow:auto;"></div>

        <div style="margin-top:16px;">
          <button id="clearSessionBtn" class="btn ghost" style="width:100%;">æ¸…ç©ºä¼šè¯</button>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="small-muted">å†…éƒ¨</div>
      <div class="small-muted">Â© å¤šè½®çŸ¥è¯†å¯¹è¯ç³»ç»Ÿ</div>
    </div>
  </div>
</div>

<div id="loginModal" class="modal-overlay" style="display:none;">
  <div class="login-modal" role="dialog" aria-modal="true">
    <h3>ç³»ç»Ÿç™»å½•</h3>
    <div class="small-muted">ç™»å½•è¿”å› map.put("token", jwt); map.put("error_msg", "success"); token å°†è¢«ç”¨äº Authorization: Bearer &lt;token&gt;</div>

    <div class="login-row">
      <input id="loginUsername" placeholder="ç”¨æˆ·å / å·¥å·" />
      <input id="loginPassword" type="password" placeholder="å¯†ç " />
    </div>

    <div class="login-actions">
      <button class="btn ghost" id="loginCancel">å–æ¶ˆ</button>
      <button class="btn" id="loginSubmit">ç™»å½•</button>
    </div>

    <div id="loginMsg" style="margin-top:12px;color:#ef4444;display:none;font-size:14px;"></div>
  </div>
</div>

<script>
/*
  å®Œæ•´è¯´æ˜ï¼ˆå‰ç«¯è¡Œä¸ºï¼‰ï¼š
  - LOGIN_API ä¸ºç©ºæ—¶ï¼šæ‰§è¡Œæœ¬åœ°æ¨¡æ‹Ÿç™»å½•ï¼ˆç”¨äºå†…ç½‘/å¼€å‘ï¼‰
  - è‹¥è®¾ä¸ºçœŸå®ç™»å½•åœ°å€ï¼Œè¯·ç¡®ä¿åç«¯è¿”å› JSONï¼š{ "token": "jwt...", "error_msg": "success" }
  - CHAT_APIï¼š/llm/api/knowledge_chat_conversation ï¼ˆåç«¯éœ€æ”¯æŒ SSE æˆ–æµå¼è¿”å›ï¼‰
  - SSE data å‰ç¼€æ”¯æŒï¼š
      SESSION:<session_id>
      CONTENT:<chunk>            (ç”¨äºè¡¥å……æ­£æ–‡)
      THINK:<chunk>              (ç”¨äºè¡¥å……æ€è€ƒè¿‡ç¨‹)
      SOURCE:<json>              (json è¡¨ç¤ºå‚è€ƒæ¥æºå¯¹è±¡)
      ERROR:<msg>
      DONE:
    å‰ç«¯å°†æŠŠ THINK å†…å®¹æ”¾åˆ°ã€Œæ€è€ƒè¿‡ç¨‹ã€åˆ†åŒºï¼ŒCONTENT æ”¾åˆ°ã€Œæ­£æ–‡ã€åˆ†åŒºã€‚
*/

const LOGIN_API = "/api/auth/login";
const CHAT_API = "/llm/api/knowledge_chat_conversation";
const STORAGE_TOKEN_KEY = "multi_turn_chat_jwt";
const STORAGE_SESSION_KEY = "multi_turn_chat_session_id";
const STORAGE_USER_KEY = "multi_turn_chat_user";

const loginModal = document.getElementById("loginModal");
const btnOpenLogin = document.getElementById("btnOpenLogin");
const btnLogout = document.getElementById("btnLogout");
const loginSubmit = document.getElementById("loginSubmit");
const loginCancel = document.getElementById("loginCancel");
const loginUsername = document.getElementById("loginUsername");
const loginPassword = document.getElementById("loginPassword");
const loginMsg = document.getElementById("loginMsg");
const statusText = document.getElementById("statusText");

const submitBtn = document.getElementById("submitBtn");
const questionInput = document.getElementById("questionInput");
const modelSelector = document.getElementById("modelSelector");
const rerankTopNInput = document.getElementById("rerankTopNInput");
const thinkingModeToggle = document.getElementById("thinkingModeToggle");
const insertBlockToggle = document.getElementById("insertBlockToggle");
const conversation = document.getElementById("conversation");
const references = document.getElementById("references");
const currentSessionEl = document.getElementById("currentSession");
const clearSessionBtn = document.getElementById("clearSessionBtn");
const liveLoader = document.getElementById("liveLoader");
const lockedOverlay = document.getElementById("lockedOverlay");
const welcomeNote = document.getElementById("welcomeNote");
const toggleRefsBtn = document.getElementById("toggleRefsBtn");
const sidebar = document.getElementById("sidebar");
const refCountEl = document.getElementById("refCount");

let jwtToken = localStorage.getItem(STORAGE_TOKEN_KEY) || null;
let sessionId = localStorage.getItem(STORAGE_SESSION_KEY) || null;
let username = localStorage.getItem(STORAGE_USER_KEY) || null;

updateLoginUI();

/* ------------------ ç™»å½•ç›¸å…³ ------------------ */
btnOpenLogin.addEventListener("click", () => {
  loginMsg.style.display = "none";
  loginModal.style.display = "flex";
  loginUsername.value = username || "";
  loginPassword.value = "";
});
loginCancel.addEventListener("click", () => {
  loginModal.style.display = "none";
});
btnLogout.addEventListener("click", () => { logout(); });

loginSubmit.addEventListener("click", async () => {
  loginMsg.style.display = "none";
  const user = loginUsername.value.trim();
  const pass = loginPassword.value.trim();
  if (!user || !pass) {
    loginMsg.style.display = "block";
    loginMsg.textContent = "ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©ºã€‚";
    return;
  }
  loginSubmit.disabled = true;
  loginSubmit.textContent = "ç™»å½•ä¸­...";
  try {
    let tokenResp;
    if (!LOGIN_API) {
      tokenResp = { token: "SIM_JWT_" + btoa(user).slice(0,24), error_msg: "success" };
      await new Promise(r => setTimeout(r, 350));
    } else {
      const resp = await fetch(LOGIN_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: user, password: pass })
      });


        // <-- ã€ä¿®æ”¹ç‚¹ 1ã€‘: æ·»åŠ  503 ç»´æŠ¤æ£€æŸ¥
      if (resp.status === 503) {
          console.warn("æ£€æµ‹åˆ°æœåŠ¡å™¨æ­£åœ¨ç»´æŠ¤(ç™»å½•)...");
          window.location.reload();
          throw new Error("æœåŠ¡å™¨ç»´æŠ¤ä¸­ï¼Œæ­£åœ¨åˆ·æ–°...");
      }
      // -- æ£€æŸ¥ç»“æŸ


      if (!resp.ok) throw new Error("ç™»å½•è¯·æ±‚å¤±è´¥: " + resp.status);
      tokenResp = await resp.json();
    }
    if (!tokenResp || !tokenResp.token || tokenResp.error_msg !== "success") {
      throw new Error((tokenResp && tokenResp.error_msg) ? tokenResp.error_msg : "ç™»å½•è¿”å›æ ¼å¼å¼‚å¸¸");
    }
    jwtToken = tokenResp.token;
    username = user;
    localStorage.setItem(STORAGE_TOKEN_KEY, jwtToken);
    localStorage.setItem(STORAGE_USER_KEY, username);
    loginModal.style.display = "none";
    updateLoginUI();
    appendSystemMessage(`ç™»å½•æˆåŠŸï¼š${username}`);
  } catch (err) {
    console.error("login error", err);
    loginMsg.style.display = "block";
    loginMsg.textContent = "ç™»å½•å¤±è´¥ï¼š" + (err.message || err);
  } finally {
    loginSubmit.disabled = false;
    loginSubmit.textContent = "ç™»å½•";
  }
});

function updateLoginUI() {
  jwtToken = localStorage.getItem(STORAGE_TOKEN_KEY);
  sessionId = localStorage.getItem(STORAGE_SESSION_KEY);
  username = localStorage.getItem(STORAGE_USER_KEY);
  const loggedIn = !!jwtToken;
  statusText.textContent = loggedIn ? `å·²ç™»å½•ï¼š${username || 'ç”¨æˆ·'}` : "æœªç™»å½•";
  btnLogout.style.display = loggedIn ? "inline-block" : "none";
  btnOpenLogin.style.display = loggedIn ? "none" : "inline-block";
  submitBtn.disabled = !loggedIn;
  lockedOverlay.style.display = loggedIn ? "none" : "flex";
  currentSessionEl.textContent = "ä¼šè¯ï¼š" + (sessionId ? sessionId.substring(0, 8) + '...' : "æ— ");
}

/* ------------------ ä¼šè¯æ¸…ç©º (å·²ä¿®å¤) ------------------ */
clearSessionBtn.addEventListener("click", async () => {
  const currentSessionId = sessionId; // å¤‡ä»½å½“å‰IDç”¨äºAPIè°ƒç”¨
  if (currentSessionId) {
      try {
          const resp = await fetch("/llm/api/conversation/clear", {
              method: "POST",
              headers: { "Content-Type": "application/json", ...(jwtToken ? { "Authorization": "Bearer " + jwtToken } : {}) },
              body: JSON.stringify({ session_id: currentSessionId })
          });

          // æ·»åŠ  503 ç»´æŠ¤æ£€æŸ¥
          if (resp.status === 503) {
              console.warn("æ£€æµ‹åˆ°æœåŠ¡å™¨æ­£åœ¨ç»´æŠ¤(æ¸…ç©ºä¼šè¯)...");
              window.location.reload();
              throw new Error("æœåŠ¡å™¨ç»´æŠ¤ä¸­ï¼Œæ­£åœ¨åˆ·æ–°...");
          }

      } catch (e) {
          console.warn("è°ƒç”¨åç«¯æ¸…ç©ºæ¥å£å¤±è´¥ï¼Œå°†ä»…åœ¨å‰ç«¯æ¸…é™¤ã€‚", e);
      }
  }

  // ğŸ”¥ ä¿®å¤ç‚¹ 1: æ— è®ºAPIè°ƒç”¨æˆåŠŸä¸å¦ï¼Œéƒ½å½»åº•é‡ç½®å‰ç«¯çŠ¶æ€
  localStorage.removeItem(STORAGE_SESSION_KEY);
  sessionId = null; // æ˜¾å¼é‡ç½®JSå˜é‡
  updateLoginUI();  // è°ƒç”¨ç»Ÿä¸€çš„UIæ›´æ–°å‡½æ•°ï¼Œç¡®ä¿æ‰€æœ‰æ˜¾ç¤ºåŒæ­¥

  // æ¸…ç©ºUIæ˜¾ç¤ºåŒºåŸŸ
  conversation.innerHTML = '<div class="small-muted" id="welcomeNote">âœ¨ ä¼šè¯å·²æ¸…ç©ºï¼Œå‘é€æ–°é—®é¢˜å°†è‡ªåŠ¨åˆ›å»ºæ–°çš„ä¼šè¯ã€‚</div>';
  references.innerHTML = '';
  refCountEl.textContent = '0 æ¡';
  appendSystemMessage("âœ… æœ¬åœ°ä¼šè¯å·²æ¸…ç©ºï¼Œä¸‹æ¬¡å‘é€å°†åˆ›å»ºæ–°å¯¹è¯ã€‚");
});


/* ------------------ æŠ˜å /å±•å¼€å‚è€ƒæ¥æº ------------------ */
let refsExpanded = false;
toggleRefsBtn.addEventListener("click", () => {
  refsExpanded = !refsExpanded;
  if (refsExpanded) {
    sidebar.classList.remove('references-collapsed');
    sidebar.classList.add('references-expanded');
    toggleRefsBtn.innerText = 'æ”¶èµ· â–´';
  } else {
    sidebar.classList.remove('references-expanded');
    sidebar.classList.add('references-collapsed');
    toggleRefsBtn.innerText = 'æ›´å¤šæ¥æº â–¾';
  }
});

/* ------------------ å‘é€/æ¥æ”¶æµå¼ (å·²ä¿®å¤) ------------------ */
submitBtn.addEventListener("click", handleSubmit);
questionInput.addEventListener("keydown", (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); handleSubmit(); } });

let abortController = null;
let totalReferences = 0;

async function handleSubmit() {
  const question = questionInput.value.trim();
  if (!question) { alert("é—®é¢˜ä¸èƒ½ä¸ºç©º"); return; }
  if (!jwtToken) { alert("è¯·å…ˆç™»å½•"); return; }

  submitBtn.disabled = true;
  liveLoader.style.display = 'inline-block';
  welcomeNote && (welcomeNote.style.display = "none");

  appendUserMessage(question);
  questionInput.value = "";

  const payload = {
    question: question,
    session_id: sessionId || null,
    thinking: !!thinkingModeToggle.checked,
    model_id: modelSelector.value,
    rerank_top_n: Number(rerankTopNInput.value || 10),
    use_insert_block: !!insertBlockToggle.checked
  };

  try {
    abortController && abortController.abort();
    abortController = new AbortController();

    const resp = await fetch(CHAT_API, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + jwtToken },
      body: JSON.stringify(payload),
      signal: abortController.signal
    });

    if (!resp.ok) throw new Error("æœåŠ¡å™¨è¿”å›é”™è¯¯: " + resp.status);

    const reader = resp.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buffer = "";
    const assistantBubbleEl = appendAssistantContainer();
    totalReferences = 0;
    refCountEl.innerText = `${totalReferences} æ¡`;
    references.innerHTML = '';

    let thinkingSoFar = "";
    let finalSoFar = "";

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      let parts = buffer.split("\n\n");
      buffer = parts.pop();
      for (const part of parts) {
        const trimmed = part.trim();
        if (!trimmed) continue;
        let raw = trimmed;
        if (raw.startsWith("data:")) raw = raw.substring(5).trim();

        if (raw.startsWith("SESSION:")) {
          const sid = raw.substring("SESSION:".length).trim();
          if (sid) {
            sessionId = sid;
            localStorage.setItem(STORAGE_SESSION_KEY, sessionId);
            updateLoginUI();
          }
        } else if (raw.startsWith("THINK:")) {
          thinkingSoFar += raw.substring("THINK:".length);
          updateAssistantThinking(assistantBubbleEl, thinkingSoFar);
        } else if (raw.startsWith("CONTENT:")) {
          finalSoFar += raw.substring("CONTENT:".length);
          updateAssistantFinal(assistantBubbleEl, finalSoFar);
        } else if (raw.startsWith("SOURCE:")) {
          try {
            const src = JSON.parse(raw.substring("SOURCE:".length).trim());
            prependReference(src);
            totalReferences++;
            refCountEl.innerText = `${totalReferences} æ¡`;
          } catch (e) { console.warn("è§£æ SOURCE å¤±è´¥ï¼š", e, raw); }
        } else if (raw.startsWith("ERROR:")) {
          updateAssistantFinal(assistantBubbleEl, "å‘ç”Ÿé”™è¯¯ï¼š" + raw.substring("ERROR:".length).trim());
        } else if (raw.startsWith("DONE:")) {
          console.log("Stream finished.");
        } else {
          // ğŸ”¥ ä¿®å¤ï¼šç§»é™¤è‡ªåŠ¨è¿½åŠ åˆ°æ­£æ–‡çš„é€»è¾‘ï¼Œæ”¹ä¸ºè­¦å‘Š
          console.warn("æ”¶åˆ°æœªè¯†åˆ«çš„æ•°æ®æ ¼å¼:", raw);
          // å¦‚æœç¡®å®éœ€è¦å…œåº•å¤„ç†ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢çš„æ³¨é‡Šï¼ˆä½†å»ºè®®åç«¯è§„èŒƒåŒ–è¾“å‡ºï¼‰
          // finalSoFar += raw;
          // updateAssistantFinal(assistantBubbleEl, finalSoFar);
        }
      }
    }
  } catch (err) {
    // åªæœ‰åœ¨ä¸æ˜¯ 503 é”™è¯¯æ—¶æ‰æç¤º
    if (err.name === 'AbortError') {
      appendSystemMessage("è¯·æ±‚å·²ä¸­æ­¢ã€‚");
    } else if (err.message.indexOf("ç»´æŠ¤ä¸­") === -1) {
      appendSystemMessage("è¯·æ±‚å¤±è´¥ï¼š" + (err.message || err));
    }
  } finally {
    liveLoader.style.display = 'none';
    submitBtn.disabled = false;
    updateLoginUI();
  }
}

/* ------------------ è¾…åŠ© UI æ“ä½œï¼ˆæ¶ˆæ¯è¿½åŠ ï¼‰ ------------------ */
function appendUserMessage(text) {
  const div = document.createElement("div");
  div.className = "msg user";
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.innerText = text;
  div.appendChild(bubble);
  conversation.appendChild(div);
  conversation.scrollTop = conversation.scrollHeight;
}

function appendAssistantContainer() {
  const div = document.createElement("div");
  div.className = "msg assistant";
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  const block = document.createElement("div");
  block.className = "assistant-block";
  const thinkingSection = document.createElement("div");
  thinkingSection.className = "block-section";
  thinkingSection.style.display = thinkingModeToggle.checked ? "block" : "none";
  const thinkingTitle = document.createElement("div");
  thinkingTitle.className = "section-title";
  thinkingTitle.innerHTML = `<span class="label">æ€è€ƒè¿‡ç¨‹</span><button class="toggle-small">æ”¶èµ·</button>`;
  const thinkingBody = document.createElement("div");
  thinkingBody.className = "section-body";
  thinkingBody.style.whiteSpace = "pre-wrap";
  const finalSection = document.createElement("div");
  finalSection.className = "block-section";
  const finalTitle = document.createElement("div");
  finalTitle.className = "section-title";
  finalTitle.innerHTML = `<span class="label">æ­£æ–‡</span><span class="small-muted">ï¼ˆæœ€ç»ˆå›ç­”ï¼‰</span>`;
  const finalBody = document.createElement("div");
  finalBody.className = "section-body";
  thinkingSection.appendChild(thinkingTitle);
  thinkingSection.appendChild(thinkingBody);
  finalSection.appendChild(finalTitle);
  finalSection.appendChild(finalBody);
  block.appendChild(thinkingSection);
  block.appendChild(finalSection);
  bubble.appendChild(block);
  div.appendChild(bubble);
  conversation.appendChild(div);
  conversation.scrollTop = conversation.scrollHeight;
  const tBtn = thinkingTitle.querySelector('button.toggle-small');
  tBtn.addEventListener('click', () => {
    if (thinkingBody.style.display === 'none') {
      thinkingBody.style.display = 'block';
      tBtn.innerText = 'æ”¶èµ·';
    } else {
      thinkingBody.style.display = 'none';
      tBtn.innerText = 'å±•å¼€';
    }
    conversation.scrollTop = conversation.scrollHeight;
  });
  return { thinkingBody, finalBody };
}

function updateAssistantThinking(container, text) {
  if (!container) return;
  // ğŸ”¥ ä¿®å¤ï¼šå°†åç«¯çš„ \u2029 è½¬æ¢å› \n
  const normalizedText = text.replace(/\u2029/g, '\n');
  container.thinkingBody.innerText = normalizedText;
  conversation.scrollTop = conversation.scrollHeight;
}

function updateAssistantFinal(container, text) {
  if (!container) return;
  // ğŸ”¥ ä¿®å¤ï¼šå°†åç«¯çš„ \u2029 è½¬æ¢å› \n
  const normalizedText = text.replace(/\u2029/g, '\n');

  if (window.marked) {
    try {
      // é…ç½® marked é€‰é¡¹ï¼Œç¡®ä¿æ­£ç¡®å¤„ç†æ¢è¡Œå’ŒGFMæ ¼å¼
      container.finalBody.innerHTML = window.marked.parse(normalizedText, {
        breaks: true,  // å°†å•ä¸ªæ¢è¡Œç¬¦è½¬æ¢ä¸º <br>
        gfm: true,     // å¯ç”¨ GitHub Flavored Markdown
        headerIds: false,  // ç¦ç”¨æ ‡é¢˜IDé¿å…å†²çª
        mangle: false  // ç¦ç”¨é‚®ç®±æ··æ·†
      });
    }
    catch (e) {
      console.error("Markdownè§£æå¤±è´¥:", e);
      // é™çº§å¤„ç†ï¼šä½¿ç”¨pre-wrapä¿ç•™æ¢è¡Œ
      container.finalBody.style.whiteSpace = 'pre-wrap';
      container.finalBody.innerText = normalizedText;
    }
  } else {
    // å¦‚æœmarked.jsæœªåŠ è½½ï¼Œä½¿ç”¨pre-wrapä¿ç•™æ¢è¡Œ
    container.finalBody.style.whiteSpace = 'pre-wrap';
    container.finalBody.innerText = normalizedText;
  }
  conversation.scrollTop = conversation.scrollHeight;
}

function appendSystemMessage(text) {
  const div = document.createElement("div");
  div.className = "msg assistant";
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.style.background = "linear-gradient(90deg,#eef6ff,#ffffff)";
  bubble.style.color = "#0f172a";
  bubble.innerText = text;
  div.appendChild(bubble);
  conversation.appendChild(div);
  conversation.scrollTop = conversation.scrollHeight;
}

/* ------------------ å‚è€ƒæ¥æºæ·»åŠ  ------------------ */
function prependReference(src) {
  const el = document.createElement('div');
  el.className = 'reference-item';
  const title = src.fileName || (`æ¥æº ${src.id || ''}`);
  const meta = `åˆå§‹åˆ†: ${src.initialScore ?? '-'} | é‡æ’åˆ†: ${src.rerankedScore ?? '-'} ${src.canAnswer ? ' | å¯å›ç­” âœ“' : ''}`;
  let html = `<div style="font-weight:700;margin-bottom:6px;">${escapeHtml(title)}</div>`;
  html += `<div class="reference-meta">${escapeHtml(meta)}</div>`;
  if (src.content) html += `<div>${escapeHtml(src.content).replace(/\n/g,'<br>')}</div>`;
  if (src.keyPassage) html += `<div class="ref-keypassage">${escapeHtml(src.keyPassage)}</div>`;
  if (src.url) html += `<div style="margin-top:8px;"><a href="${escapeHtml(src.url)}" target="_blank" rel="noreferrer">æ‰“å¼€æ¥æº</a></div>`;
  el.innerHTML = html;
  references.prepend(el);
}

/* ------------------ å·¥å…·å‡½æ•° ------------------ */
function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
}

/* ------------------ é¡µé¢è½½å…¥æ—¶è¡Œä¸º ------------------ */
window.addEventListener('load', () => {
  updateLoginUI();
  if (!jwtToken) {
    setTimeout(() => { loginModal.style.display = 'flex'; }, 200);
  } else {
    appendSystemMessage("æ£€æµ‹åˆ°å·²ç™»å½•ï¼Œå¯ç»§ç»­å¤šè½®å¯¹è¯ã€‚");
  }
});

/* ------------------ ç™»å‡º ------------------ */
function logout() {
  localStorage.removeItem(STORAGE_TOKEN_KEY);
  localStorage.removeItem(STORAGE_SESSION_KEY);
  localStorage.removeItem(STORAGE_USER_KEY);
  jwtToken = null; sessionId = null; username = null;
  updateLoginUI();
  appendSystemMessage("å·²ç™»å‡ºï¼Œå½“å‰ä¼šè¯å¤±æ•ˆã€‚");
}
</script>



</body>
</html>

