<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>登录 - Exam-RAG</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f3f4f6;}
    .wrap{max-width:420px;margin:8vh auto;background:#fff;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.06);padding:24px;}
    h1{margin:0 0 8px;}
    .muted{color:#6b7280}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
    input{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px}
    button{width:100%;padding:12px;border-radius:10px;border:1px solid #11182720;background:#111827;color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .btn-outline{background:#fff;color:#111827}
    .tip{margin-top:8px;min-height:1.2em}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>登录</h1>
    <div class="muted">根据角色进入不同界面：管理员/教师 → 管理端，学生 → 考生端。</div>

    <div id="resumeBox" class="row hidden">
      <button id="btnResume">继续进入上次会话</button>
      <button id="btnClear" class="btn-outline">清除会话并重新登录</button>
    </div>

    <div class="row"><input id="u" placeholder="用户名" value="admin"/></div>
    <div class="row"><input id="p" type="password" placeholder="密码" value="admin123"/></div>
    <div class="row"><button id="btnLogin">登录</button></div>
    <div class="muted">示例账户：<code>admin/admin123</code>、<code>student01/123456</code></div>
    <div id="msg" class="tip muted"></div>
  </div>

  <script>
    const api = (p)=>`${location.origin}${p}`;
    const u = document.getElementById('u');
    const p = document.getElementById('p');
    const btnLogin = document.getElementById('btnLogin');
    const msg = document.getElementById('msg');
    const resumeBox = document.getElementById('resumeBox');
    const btnResume = document.getElementById('btnResume');
    const btnClear = document.getElementById('btnClear');

    function getAuth(){
      try{ return JSON.parse(localStorage.getItem('exam_auth')||'{}'); }catch{ return {}; }
    }
    function saveAuth(a){ localStorage.setItem('exam_auth', JSON.stringify(a||{})); }
    function clearAuth(){ localStorage.removeItem('exam_auth'); }
    function goByRole(roleRaw){
      const role = String(roleRaw||'').trim().toLowerCase();
      if(role==='admin' || role==='teacher') location.href = './admin.html';
      else location.href = './exam.html';
    }
    function hasFreshParam(){ return new URLSearchParams(location.search).has('fresh'); }

    async function verifyAndMaybeRedirect(){
      if (hasFreshParam()) { resumeBox.classList.remove('hidden'); return; }
      const a = getAuth();
      if(!a?.token){ resumeBox.classList.add('hidden'); return; }
      try{
        const ctrl = new AbortController(); const id=setTimeout(()=>ctrl.abort('timeout'), 5000);
        const r = await fetch(api('/auth/me'), { headers: { 'Authorization': 'Bearer '+a.token }, signal: ctrl.signal });
        clearTimeout(id);
        if(!r.ok) throw new Error();
        resumeBox.classList.remove('hidden');
      }catch{ clearAuth(); resumeBox.classList.add('hidden'); }
    }

    async function doLogin(){
      btnLogin.disabled = true; msg.textContent = '登录中...';
      try{
        const ctrl = new AbortController(); const id=setTimeout(()=>ctrl.abort('timeout'), 8000);
        const r = await fetch(api('/auth/login'), {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ username: u.value.trim(), password: p.value.trim() }),
          signal: ctrl.signal
        });
        clearTimeout(id);
        const j = await r.json();
        if(!j.ok) throw new Error(j.detail||'登录失败');
        saveAuth({ token:j.token, user:j.user });
        goByRole(j.user.role);
      }catch(e){ msg.textContent = '登录失败：' + e; }
      finally{ btnLogin.disabled = false; }
    }

    btnLogin.addEventListener('click', doLogin);
    btnResume.addEventListener('click', ()=>{ const a=getAuth(); if(a?.user?.role) goByRole(a.user.role); });
    btnClear.addEventListener('click', ()=>{ clearAuth(); resumeBox.classList.add('hidden'); msg.textContent='已清除会话，请重新登录'; });

    verifyAndMaybeRedirect();
  </script>
</body>
</html>
