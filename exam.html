<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å­¦ç”Ÿç«¯è€ƒè¯• | Exam-RAG</title>
<style>
  :root{
    --bg:#f7f8fb; --card:#ffffff; --muted:#6b7280; --border:#e5e7eb; --ink:#111827;
    --pri:#2b7cff; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --nav:#94a3b8;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  /* é¡¶æ  */
  .topbar{position:sticky;top:0;z-index:9;background:rgba(247,248,251,.8);backdrop-filter:blur(6px);
    border-bottom:1px solid var(--border)}
  .topwrap{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{font-size:18px;margin:0 8px 0 0}
  .muted{color:var(--muted)}
  select,input,button{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;font:14px/1.4 inherit}
  button{background:#fff;cursor:pointer}
  .btn{border:1px solid var(--border)}
  .btn.primary{background:var(--pri);border-color:var(--pri);color:#fff}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .time{margin-left:auto;display:flex;align-items:center;gap:10px}
  .pill{border:1px solid var(--border);border-radius:999px;padding:4px 10px;background:#fff}
  /* å¸ƒå±€ */
  .wrap{max-width:1100px;margin:14px auto;padding:0 16px;display:grid;grid-template-columns:240px 1fr;gap:14px}
  @media (max-width: 900px){ .wrap{grid-template-columns:1fr} }
  /* ä¾§æ ï¼ˆå¯¼èˆªï¼‰ */
  .side{position:sticky;top:58px;align-self:start}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
  .side h3{margin:0 0 8px;font-size:14px}
  .navgrid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
  .navbtn{padding:8px 0;border:1px solid var(--border);border-radius:10px;background:#fff;text-align:center}
  .navbtn.answered{border-color:var(--pri);background:#eff6ff;color:#1e40af}
  .navbtn.current{outline:2px solid var(--pri)}
  /* ä¸»åŒº */
  .main .head{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .main .head h2{margin:0;font-size:16px}
  .main .head .sub{margin-left:auto;color:var(--muted)}
  .q{border:1px solid var(--border);border-radius:14px;padding:14px;background:#fff;margin-bottom:12px}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);margin-left:6px}
  .tag.single{background:#eef2ff;color:#3730a3;border-color:#c7d2fe}
  .tag.multi{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
  .opts{margin-top:10px}
  .opt{display:block;width:100%;text-align:left;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fafafa;margin:6px 0}
  .opt.active{border-color:var(--pri);background:#eff6ff}
  .pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
  .err{white-space:pre-wrap;color:#991b1b;background:#fef2f2;border:1px solid #fecaca;padding:10px;border-radius:10px;margin-top:10px}
  /* ç»“æœ */
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .chart{border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center}
  .legend{display:flex;gap:8px;flex-wrap:wrap}
  .lg{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px 10px;background:#fff}
  .lg.ok{border-color:#a7f3d0;background:#ecfdf5}
  .lg.partial{border-color:#fde68a;background:#fffbeb}
  .lg.bad{border-color:#fecaca;background:#fef2f2}
  .qgrid{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;margin-top:8px}
  .qcell{padding:6px 8px;border:1px solid var(--border);border-radius:10px;text-align:center}
  .qcell.ok{border-color:var(--ok)}
  .qcell.partial{border-color:var(--warn)}
  .qcell.bad{border-color:var(--bad)}
  .analysis{white-space:pre-wrap;background:#fff;border:1px dashed var(--border);padding:10px;border-radius:10px;margin-top:10px;overflow-wrap:anywhere}
  .footact{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>

<!-- é¡¶éƒ¨å·¥å…·æ¡ -->
<div class="topbar">
  <div class="topwrap">
    <h1>å­¦ç”Ÿç«¯è€ƒè¯•</h1>
    <label class="muted">è¯•å·ï¼š</label>
    <select id="paperSel" style="min-width:260px"></select>
    <button id="btnReload" class="btn">åˆ·æ–°è¯•å·åˆ—è¡¨</button>

    <label class="muted">æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ï¼š</label>
    <input id="durationMin" type="number" min="1" step="1" value="30" style="width:90px"/>
    <button id="btnStart" class="btn primary">å¼€å§‹ä½œç­”</button>

    <div class="time">
      <span class="muted">å€’è®¡æ—¶ï¼š</span>
      <span id="leftTime" class="pill">--:--</span>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- å·¦ä¾§å¯¼èˆª -->
  <div class="side card">
    <h3>é¢˜ç›®å¯¼èˆª</h3>
    <div id="navGrid" class="navgrid"></div>
    <div class="pager" style="margin-top:10px">
      <button id="prevPage" class="btn">ä¸Šä¸€é¡µ</button>
      <span class="muted" id="pageInfo"></span>
      <button id="nextPage" class="btn">ä¸‹ä¸€é¡µ</button>
    </div>
  </div>

  <!-- ä¸»å†…å®¹ -->
  <div class="main">
    <div class="card head">
      <h2 id="paperTitle">å°šæœªå¼€å§‹</h2>
      <div class="sub"><span class="muted">æ¯é¡µæ˜¾ç¤º</span>
        <select id="pageSize" title="æ¯é¡µé¢˜ç›®æ•°">
          <option value="3" selected>3</option>
          <option value="5">5</option>
          <option value="10">10</option>
        </select>
        <span class="muted">é¢˜</span>
      </div>
    </div>

    <div id="errBox" class="err" style="display:none"></div>
    <div id="qList"></div>

    <div class="card footact">
      <button id="btnSubmit" class="btn primary">äº¤å·å¹¶è¯„åˆ†</button>
      <span id="submitMsg" class="muted"></span>
    </div>

    <div id="resultPanel" class="card" style="display:none">
      <h3>è€ƒè¯•ç»“æœ</h3>
      <div class="grid">
        <div class="chart">
          <!-- æ”¹æˆåœ†ç¯ï¼šå»ºè®®æ–¹å½¢ç”»å¸ƒ -->
          <canvas id="scoreChart" width="220" height="220"></canvas>
        </div>
        <div class="chart">
          <div class="legend">
            <span class="lg ok">âœ… æ­£ç¡®</span>
            <span class="lg partial">ğŸŸ¡ éƒ¨åˆ†å¾—åˆ†</span>
            <span class="lg bad">âŒ é”™è¯¯</span>
          </div>
          <div id="statText" class="muted" style="margin-top:10px"></div>
          <div id="qGrid" class="qgrid"></div>
        </div>
      </div>
      <div style="margin-top:10px">
        <button id="btnExport" class="btn">å¯¼å‡ºæˆç»©æŠ¥å‘Šï¼ˆDOCXï¼‰</button>
        <span id="exportMsg" class="muted"></span>
      </div>
    </div>

    <div id="reviewPanel" class="card" style="display:none">
      <h3>ç­”æ¡ˆä¸è§£æ</h3>
      <div id="reviewList"></div>
    </div>
  </div>
</div>

<script>
/* ====== æ¥å£å¸¸é‡ï¼ˆå…¨éƒ¨èµ° /mcq_public å‰ç¼€ï¼‰ ====== */
const API_PAPER_LIST    = "/mcq_public/papers/list_open";
const API_PAPER_VIEW    = "/mcq_public/papers/view";          // ?paper_id=...
const API_EXAM_START    = "/mcq_public/exam/start";
const API_EXAM_SUBMIT   = "/mcq_public/exam/submit";
const API_EXAM_REVIEW   = "/mcq_public/exam/review";          // ?attempt_id=...
const API_EXPORT_REPORT = "/mcq_public/student/export_my_report_docx";

/* ====== å¯è°ƒå‚æ•° ====== */
let PAGE_SIZE = 3;             // é»˜è®¤æ¯é¡µ 3 é¢˜
const REQ_TIMEOUT_MS = 120000; // ç»Ÿä¸€è¶…æ—¶æ—¶é•¿

/* ====== çŠ¶æ€ ====== */
let papers = [];
let paper = null;              // { ok, title, items:[{qid, stem, options, qtype}] }
let answers = new Map();       // qid -> Set(labels)
let attemptId = null;
let timer = null;
let leftSec = 0;
let currentPage = 1;
let submitted = false;

/* ====== DOM ====== */
const $ = id => document.getElementById(id);
const els = {
  paperSel:  $("paperSel"),
  btnReload: $("btnReload"),
  durationMin: $("durationMin"),
  btnStart: $("btnStart"),
  leftTime: $("leftTime"),
  navGrid: $("navGrid"),
  pageInfo: $("pageInfo"),
  prevPage: $("prevPage"),
  nextPage: $("nextPage"),
  pageSize: $("pageSize"),
  paperTitle: $("paperTitle"),
  errBox: $("errBox"),
  qList: $("qList"),
  btnSubmit: $("btnSubmit"),
  submitMsg: $("submitMsg"),
  resultPanel: $("resultPanel"),
  scoreChart: $("scoreChart"),
  statText: $("statText"),
  qGrid: $("qGrid"),
  reviewPanel: $("reviewPanel"),
  reviewList: $("reviewList"),
  btnExport: $("btnExport"),
  exportMsg: $("exportMsg"),
};

/* ====== å·¥å…· ====== */
function setText(el, s){ el.textContent = s || ""; }
function showErr(s){ els.errBox.style.display="block"; els.errBox.textContent = s || "æœªçŸ¥é”™è¯¯"; }
function hideErr(){ els.errBox.style.display="none"; els.errBox.textContent = ""; }
function escapeHtml(s){ s = String(s==null?"":s); return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function secFmt(n){ const m = Math.floor(n/60), s = n%60; return `${m}:${s<10?'0'+s:s}`; }

/* ====== HiDPI é€‚é… + åœ†ç¯ç»˜åˆ¶ ====== */
function setupHiDPICanvas(canvas, cssW, cssH){
  const ratio = Math.max(1, Math.floor(window.devicePixelRatio || 1));
  canvas.style.width = cssW + "px";
  canvas.style.height = cssH + "px";
  canvas.width = cssW * ratio;
  canvas.height = cssH * ratio;
  const ctx = canvas.getContext('2d');
  ctx.scale(ratio, ratio);
  return ctx;
}

/** ç”»åœ†ç¯è¿›åº¦ï¼ˆ0~1ï¼‰ï¼Œä¸­å¿ƒæ˜¾ç¤ºç™¾åˆ†æ¯”ä¸åˆ†æ•° */
function drawRing(canvas, correct, total){
  const size = 220;                   // ç”»å¸ƒ CSS å°ºå¯¸ï¼ˆä¸ <canvas> ä¿æŒä¸€è‡´ï¼‰
  const ctx = setupHiDPICanvas(canvas, size, size);
  const cx = size/2, cy = size/2;
  const radius = 88;                  // åŠå¾„
  const thick = 16;                   // åœ†ç¯åšåº¦
  const start = -Math.PI/2;           // ä» 12 ç‚¹æ–¹å‘å¼€å§‹
  const pct = total ? Math.max(0, Math.min(1, correct/total)) : 0;

  // èƒŒæ™¯
  ctx.clearRect(0,0,size,size);
  ctx.lineCap = "round";

  // è½¨é“
  ctx.beginPath();
  ctx.strokeStyle = "#e5e7eb";
  ctx.lineWidth = thick;
  ctx.arc(cx, cy, radius, 0, Math.PI*2);
  ctx.stroke();

  // è¿›åº¦
  ctx.beginPath();
  ctx.strokeStyle = "#2b7cff";
  ctx.lineWidth = thick;
  ctx.arc(cx, cy, radius, start, start + Math.PI*2*pct, false);
  ctx.stroke();

  // å†…é˜´å½±/å†…åœˆï¼ˆå¯é€‰ï¼šåšä¸€ä¸ªæ·¡æ·¡çš„å†…åœˆæé«˜è´¨æ„Ÿï¼‰
  ctx.beginPath();
  ctx.strokeStyle = "rgba(0,0,0,0.04)";
  ctx.lineWidth = 1;
  ctx.arc(cx, cy, radius - thick/2, 0, Math.PI*2);
  ctx.stroke();

  // ä¸­å¿ƒæ–‡æœ¬
  const percentTxt = total ? Math.round(pct*100) + "%" : "--%";
  ctx.fillStyle = "#111827";
  ctx.font = "bold 24px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(percentTxt, cx, cy - 8);

  ctx.fillStyle = "#6b7280";
  ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText(`æ­£ç¡® ${correct} / ${total}`, cx, cy + 14);
}

/* ====== å®‰å…¨ JSON fetch ====== */
const REQ_TIMEOUT_MS = 120000;
async function safeJsonFetch(url, opts={}){
  const ac = new AbortController();
  const to = setTimeout(()=>ac.abort(), REQ_TIMEOUT_MS);
  try{
    const r = await fetch(url, {...opts, signal: ac.signal});
    const ct = (r.headers.get('content-type')||'').toLowerCase();
    if (!ct.includes('application/json')){
      const txt = await r.text();
      throw new Error(`HTTP ${r.status} é JSON å“åº”ï¼š\n${txt.substring(0,800)}`);
    }
    const j = await r.json();
    if (!r.ok){ throw new Error(`HTTP ${r.status}ï¼š${JSON.stringify(j)}`); }
    return j;
  } finally { clearTimeout(to); }
}

/* ====== é¢˜ç›®æ¸²æŸ“ ====== */
function optButton(q, label, text){
  const btn = document.createElement('button');
  btn.className = 'opt';
  btn.textContent = `${label}. ${text}`;
  btn.addEventListener('click', () => {
    if (submitted) return;
    const set = answers.get(q.qid) || new Set();
    if (q.qtype === 'single'){
      set.clear(); set.add(label);
      [...btn.parentElement.querySelectorAll('.opt')].forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    } else {
      if (set.has(label)){ set.delete(label); btn.classList.remove('active'); }
      else { set.add(label); btn.classList.add('active'); }
    }
    answers.set(q.qid, set);
    refreshNavState();
  });
  return btn;
}

function renderQuestions(){
  if (!paper || !paper.items){ $("qList").innerHTML=""; return; }
  const size = PAGE_SIZE;
  const total = paper.items.length;
  const maxPage = Math.max(1, Math.ceil(total / size));
  currentPage = Math.min(Math.max(1, currentPage), maxPage);
  setText(els.pageInfo, `ç¬¬ ${currentPage} / ${maxPage} é¡µ`);

  const start = (currentPage-1)*size;
  const view = paper.items.slice(start, start+size);

  const frag = document.createDocumentFragment();
  view.forEach((q, i)=>{
    const wrap = document.createElement('div'); wrap.className='q';
    const tag = q.qtype === 'multi' ? '<span class="tag multi">å¤šé€‰</span>' : '<span class="tag single">å•é€‰</span>';
    wrap.innerHTML = `<b>${start+i+1}. ${escapeHtml(q.stem || '')}</b> ${tag}`;
    const opts = document.createElement('div'); opts.className='opts';
    const chosen = answers.get(q.qid) || new Set();
    (q.options||[]).forEach(o=>{
      const b = optButton(q, o.label, o.text);
      if (chosen.has(o.label)) b.classList.add('active');
      opts.appendChild(b);
    });
    wrap.appendChild(opts);
    frag.appendChild(wrap);
  });
  els.qList.innerHTML = ""; els.qList.appendChild(frag);
}

function renderNav(){
  if (!paper || !paper.items){ els.navGrid.innerHTML=""; return; }
  const frag = document.createDocumentFragment();
  paper.items.forEach((q, idx)=>{
    const btn = document.createElement('button');
    btn.className = 'navbtn';
    btn.textContent = idx+1;
    btn.addEventListener('click', ()=>{
      const page = Math.floor(idx / PAGE_SIZE) + 1;
      currentPage = page;
      renderQuestions();
      refreshNavState(idx);
    });
    frag.appendChild(btn);
  });
  els.navGrid.innerHTML = ""; els.navGrid.appendChild(frag);
  refreshNavState();
}

function refreshNavState(currentIdx = null){
  if (!paper || !paper.items) return;
  const nodes = els.navGrid.querySelectorAll('.navbtn');
  nodes.forEach((n, i)=>{
    const q = paper.items[i];
    const answered = (answers.get(q.qid) || new Set()).size > 0;
    n.classList.toggle('answered', answered);
    const page = Math.floor(i / PAGE_SIZE) + 1;
    n.classList.toggle('current', page === currentPage || i === currentIdx);
  });
}

/* ====== è®¡æ—¶ ====== */
function startTimer(sec){
  clearInterval(timer); leftSec = sec;
  timer = setInterval(()=>{
    leftSec = Math.max(0, leftSec-1);
    setText(els.leftTime, secFmt(leftSec));
    if (leftSec===0){ clearInterval(timer); if(!submitted) submitExam(); }
  }, 1000);
}

/* ====== åç«¯äº¤äº’ ====== */
async function loadPaperList(){
  try{
    hideErr();
    const j = await safeJsonFetch(API_PAPER_LIST);
    papers = Array.isArray(j) ? j : [];
    els.paperSel.innerHTML = '';
    papers.forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p.paper_id;
      opt.textContent = `${p.title}ï¼ˆ${p.item_count||0}é¢˜ï¼‰`;
      els.paperSel.appendChild(opt);
    });
  }catch(e){
    showErr("æ‹‰å–è¯•å·åˆ—è¡¨å¤±è´¥ï¼š\n" + (e.message||e));
  }
}

async function startExam(){
  const pid = els.paperSel.value;
  if (!pid) return alert("è¯·å…ˆé€‰æ‹©è¯•å·");
  const mins = Math.max(1, parseInt(els.durationMin.value||"30",10));
  try{
    hideErr();
    const s = await safeJsonFetch(API_EXAM_START, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({paper_id:pid, duration_sec: mins*60})});
    if (!s.ok) throw new Error("start failed");
    attemptId = s.attempt_id; submitted = false;
    setText(els.leftTime, secFmt(mins*60));
    startTimer(mins*60);

    const j = await safeJsonFetch(`${API_PAPER_VIEW}?paper_id=${encodeURIComponent(pid)}`);
    if (!j.ok) throw new Error(j.detail || "view failed");
    paper = j; setText(els.paperTitle, j.title || "è¯•å·");
    answers = new Map();
    (paper.items||[]).forEach(it=>answers.set(it.qid, new Set()));
    PAGE_SIZE = parseInt(els.pageSize.value || "3", 10);
    currentPage = 1;
    renderNav();
    renderQuestions();
    setText(els.submitMsg,'');
    els.resultPanel.style.display='none';
    els.reviewPanel.style.display='none';
  }catch(e){
    showErr("å¼€å§‹è€ƒè¯•å¤±è´¥ï¼š\n" + (e.message||e));
  }
}

async function submitExam(){
  if (!attemptId) return;
  submitted = true;
  clearInterval(timer);
  setText(els.submitMsg, "è¯„åˆ†ä¸­â€¦");

  const payload = {
    attempt_id: attemptId,
    answers: Array.from(answers.entries()).map(([qid, set]) => ({ qid, chosen_labels: Array.from(set) }))
  };
  try{
    hideErr();
    const r = await safeJsonFetch(API_EXAM_SUBMIT, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if (!r.ok) throw new Error("submit failed");

    const per = r.items || [];
    const total = per.length;
    const correct = per.filter(x=>x.is_correct).length;

    // â€”â€” ä½¿ç”¨åœ†ç¯è¿›åº¦ â€”â€” //
    drawRing(els.scoreChart, correct, total);

    setText(els.statText, `æ€»é¢˜æ•°ï¼š${total}\nç­”å¯¹ï¼š${correct}\næ­£ç¡®ç‡ï¼š${total?Math.round(correct*100/total):0}%\næ€»åˆ†ï¼š${(r.total_score||0).toFixed(2)}`);

    // ç»“æœç½‘æ ¼
    els.qGrid.innerHTML = '';
    per.forEach((it,i)=>{
      const cell = document.createElement('div');
      cell.className = 'qcell';
      cell.textContent = (i+1);
      if (it.is_correct) cell.classList.add('ok');
      else if (it.score > 0) cell.classList.add('partial');
      else cell.classList.add('bad');
      els.qGrid.appendChild(cell);
    });

    els.resultPanel.style.display='block';
    setText(els.submitMsg, "è¯„åˆ†å®Œæˆ");
    setTimeout(()=>setText(els.submitMsg,''),1200);

    // å›çœ‹ & è§£æ
    const rv = await safeJsonFetch(`${API_EXAM_REVIEW}?attempt_id=${encodeURIComponent(attemptId)}`);
    if (!rv.ok) throw new Error(rv.detail || "review failed");
    renderReview(rv.items || []);
    els.reviewPanel.style.display='block';
  }catch(e){
    showErr("äº¤å·å¤±è´¥ï¼š\n" + (e.message||e));
    setText(els.submitMsg, "äº¤å·å¤±è´¥");
  }
}

function renderReview(items){
  els.reviewList.innerHTML = '';
  items.forEach((it, idx)=>{
    const wrap = document.createElement('div'); wrap.className='q';
    const tag = it.qtype === 'multi' ? '<span class="tag multi">å¤šé€‰</span>' : '<span class="tag single">å•é€‰</span>';
    wrap.innerHTML = `<b>${idx+1}. ${escapeHtml(it.stem||'')}</b> ${tag}
      <div class="muted">æ ‡å‡†ç­”æ¡ˆï¼š${escapeHtml((it.correct_labels||[]).join(''))}
       ï½œ æˆ‘çš„ä½œç­”ï¼š${escapeHtml((it.my_labels||[]).join('') || '(æœªä½œç­”)')}
       ï½œ åˆ¤å®šï¼š${it.is_correct?'æ­£ç¡®':(it.my_labels||[]).length>0?'éƒ¨åˆ†å¾—åˆ†':'é”™è¯¯'}
      </div>`;
    const ul = document.createElement('div'); ul.className='opts';
    (it.options||[]).forEach(o=>{
      const b = document.createElement('button'); b.className='opt'; b.disabled = true;
      const isStd = (it.correct_labels||[]).includes(o.label);
      const isMy  = (it.my_labels||[]).includes(o.label);
      b.textContent = `${o.label}. ${o.text}`;
      if (isStd) b.style.borderColor = '#10b981';
      if (isMy)  b.classList.add('active');
      ul.appendChild(b);
    });
    wrap.appendChild(ul);

    const analysis = document.createElement('div');
    analysis.className = 'analysis';
    analysis.textContent = (it.analysis && it.analysis.trim()) ? it.analysis : 'ï¼ˆæ— è§£æï¼‰';
    wrap.appendChild(analysis);

    els.reviewList.appendChild(wrap);
  });
}

/* ====== å¯¼å‡ºæŠ¥å‘Š ====== */
async function exportReport(){
  if (!attemptId) return;
  setText(els.exportMsg, 'å¯¼å‡ºä¸­â€¦');
  try{
    const fd = new FormData();
    fd.append('attempt_id', attemptId);
    const r = await safeJsonFetch(API_EXPORT_REPORT, {method:'POST', body:fd});
    if (!r.ok) throw new Error(r.detail || 'export failed');
    const a = document.createElement('a');
    a.href = r.download_url; a.download = 'æˆç»©æŠ¥å‘Š.docx';
    document.body.appendChild(a); a.click(); a.remove();
    setText(els.exportMsg, 'å·²å¯¼å‡º');
    setTimeout(()=>setText(els.exportMsg,''),1000);
  }catch(e){
    setText(els.exportMsg,'å¯¼å‡ºå¤±è´¥');
    showErr("å¯¼å‡ºæˆç»©æŠ¥å‘Šå¤±è´¥ï¼š\n" + (e.message||e));
  }
}

/* ====== ç»‘å®šäº‹ä»¶ ====== */
els.btnReload.addEventListener('click', loadPaperList);
els.btnStart.addEventListener('click', startExam);
els.prevPage.addEventListener('click', ()=>{ currentPage=Math.max(1,currentPage-1); renderQuestions(); refreshNavState(); });
els.nextPage.addEventListener('click', ()=>{
  const maxPage = paper && paper.items ? Math.ceil(paper.items.length / PAGE_SIZE) : 1;
  currentPage=Math.min(maxPage,currentPage+1); renderQuestions(); refreshNavState();
});
els.pageSize.addEventListener('change', ()=>{ PAGE_SIZE=parseInt(els.pageSize.value||"3",10); currentPage=1; renderQuestions(); refreshNavState(); });
els.btnSubmit.addEventListener('click', submitExam);
els.btnExport.addEventListener('click', exportReport);

/* ====== åˆå§‹åŒ– ====== */
loadPaperList();
setText(els.leftTime, "--:--");
</script>
</body>
</html>
